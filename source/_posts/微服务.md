---
title: 微服务
date: 2020-11-24 19:07:17
tags:
---

# 服务注册与发现

## Eureka

### 注册中心

申明为eureka服务端

`````java
@SpringBootApplication
@EnableEurekaServer
public class EurekaServerApplication {

    public static void main(String[] args) {
        SpringApplication.run(EurekaServerApplication.class, args);
    }

}
`````

配置信息

`````yml
server:
    port: 7001
eureka:
    instance:
    	#应用实例主机名
        hostname: eureka1
    client:
        #是否从Eureka获取注册信息,默认是true,一般server端不需要
        fetch-registry: false
        #是否向注册中心注册自己
        register-with-eureka: false
        #eurekaServer查询服务和注册服务的地址,当server是集群是，server之间互相配置
        service-url:
            defaultZone: http://eureka2:7002/eureka/
spring:
    profiles: 7001
---
server:
    port: 7002
eureka:
    instance:
        hostname: eureka2
    client:
        fetch-registry: false
        register-with-eureka: false
        service-url:
            defaultZone: http://eureka1:7001/eureka/
spring:
    profiles: 7002
`````

### 服务提供方

**@EnableEurekaClient**注解申明Eureka客户端

`````java
@SpringBootApplication
@EnableEurekaClient
public class PaymentApplication {

    public static void main(String[] args) {
        SpringApplication.run(PaymentApplication.class);
    }

}
`````

配置信息

``````yml
spring:
  application:
    #微服务名称
    name: cloud-payment-service
eureka:
  client:
    register-with-eureka: true
    #是否从eurekaServer抓取已有的注册信息
    fetch-registry: true
    service-url:
      defaultZone:  http://eureka1:7001/eureka/,http://eureka2:7002/eureka/
``````

### 服务调用方

应用配置与服务提供方一致

服务调用

`````java
private String paymentServiceName = "CLOUD-PAYMENT-SERVICE";

@GetMapping("order")
@ResponseBody
public String createPayment(){
    return restTemplate.postForObject("http://" + paymentServiceName + "/payment/save", null, String.class);
}
`````

# 负载均衡

## Ribbon

**与nginx的区别**

ngnix是服务端 的负载均衡，ribbon是客户端的负载均衡

### 工作流程

1. 选择注册中心
2. 从注册中心获取目标服务地址
3. 根据策略从获取的地址中选择一个调用服务

### 启动负载均衡

`````java
@Bean
@LoadBalanced
public RestTemplate getRestTemplate(){
    return new RestTemplate();
}
`````

通过注册的restTemplate的进行服务调用时，默认使用轮询算法

### 替换策略

# 服务调用

## openFeign

### 依赖

````xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>
````

### 使用

#### 定义接口

`````java
@Service
@FeignClient(value = "CLOUD-PAYMENT-SERVICE")
public interface OrderService {

    @PostMapping("/payment/save")
    public String save();

    @GetMapping("/payment/timeOut")
    public String timeOut();
}
`````

@FeignClient(value = "CLOUD-PAYMENT-SERVICE")：将接口与**CLOUD-PAYMENT_SERVICE**服务绑定

#### 调用服务

``````java
public String callPaymentTimeOut(){
    return orderService.timeOut();
}
``````







